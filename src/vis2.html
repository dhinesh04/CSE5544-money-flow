<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Visualization 2 – Geographical Imbalance (Net Aid Map)</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1.5rem;
      background: #f9fafb;
    }
    h1 {
      margin-top: 0;
      font-size: 1.4rem;
    }
    .chart-container {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      max-width: 1100px;
    }
    #map-container {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
      padding: 1rem;
      overflow: hidden;
    }
    svg {
      width: 100%;
      height: 550px;
    }
    .country {
      stroke: #f3f4f6;
      stroke-width: 0.6px;
      cursor: pointer;
    }
    .country:hover {
      stroke: #111827;
      stroke-width: 1.2px;
    }
    .country.no-data {
      fill: #e5e7eb;
    }

    .tooltip {
      position: absolute;
      pointer-events: none;
      background: #ffffff;
      border-radius: 8px;
      padding: 0.5rem 0.75rem;
      font-size: 0.8rem;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.18);
      border: 1px solid #e5e7eb;
      opacity: 0;
      transition: opacity 0.15s ease;
      max-width: 260px;
      z-index: 10;
      line-height: 1.4;
    }
    .tooltip strong {
      font-size: 0.9rem;
    }

    .legend {
      font-size: 0.75rem;
      fill: #4b5563;
    }
    .legend-title {
      font-size: 0.8rem;
      fill: #111827;
      font-weight: 600;
    }

    #drilldown {
      margin-top: 1.5rem;
    }
    #drilldown-title {
      font-size: 1rem;
      margin-bottom: 0.5rem;
      color: #111827;
    }
    .drilldown-content {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .panel {
      flex: 1 1 320px;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.06);
      padding: 0.75rem 1rem 1rem;
    }
    .panel h3 {
      margin: 0 0 1.5rem 0;
      font-size: 0.95rem;
    }
    .panel svg {
      width: 100%;
      height: 260px;
      margin-top: 0.5rem;
    }
    .axis path,
    .axis line {
      stroke: #d1d5db;
    }
    .axis text {
      fill: #4b5563;
      font-size: 0.75rem;
    }
    .no-data-text {
      font-size: 0.8rem;
      fill: #6b7280;
    }
  </style>
</head>
<body>
  <div class="chart-container">
    <h1>Geographical Imbalance – Net Aid (Donated − Received)</h1>
    <p style="max-width: 800px; font-size:0.9rem; color:#4b5563; margin:0 0 0.5rem;">
      Countries shaded in <span style="color:#1d4ed8;font-weight:500;">blue</span> are net donors (they donate more than they receive),
      while those in <span style="color:#b91c1c;font-weight:500;">red</span> are net recipients (they receive more than they donate),
      summed over all years in the dataset.
      Click a country to see its top donor and recipient partners.
    </p>

    <div id="map-container">
      <svg id="map-svg"></svg>
    </div>

    <div id="drilldown">
      <h2 id="drilldown-title">
        Country relationships (click a country on the map)
      </h2>
      <div class="drilldown-content">
        <div class="panel">
          <h3 id="top-donors-title">Top donors (select a country)</h3>
          <svg id="top-donors-svg"></svg>
        </div>
        <div class="panel">
          <h3 id="top-recipients-title">Top recipients (select a country)</h3>
          <svg id="top-recipients-svg"></svg>
        </div>
      </div>
    </div>
  </div>

  <div class="tooltip" id="tooltip"></div>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/topojson-client@3"></script>
  <script>
 
    const svg = d3.select("#map-svg");
    const width = 900;
    const height = 550;

    svg.attr("viewBox", `0 0 ${width} ${height}`);

    const mapG = svg.append("g").attr("class", "map-layer");
    const legendG = svg.append("g")
      .attr("class", "legend")
      .attr("transform", `translate(40, 20)`);

    const tooltip = d3.select("#tooltip");

    const projection = d3.geoNaturalEarth1();
    const path = d3.geoPath(projection);

    let rawData = [];
    let countrySummary = new Map(); 
    let selectedCountry = null;

    const drilldownTitle = document.getElementById("drilldown-title");
    const topDonorsTitle = document.getElementById("top-donors-title");
    const topRecipientsTitle = document.getElementById("top-recipients-title");

    const donorsSvg = d3.select("#top-donors-svg");
    const recipientsSvg = d3.select("#top-recipients-svg");

    const drillWidth = 430;
    const drillHeight = 260;
    const drillMargin = { top: 60, right: 20, bottom: 30, left: 120 };
    const drillInnerWidth = drillWidth - drillMargin.left - drillMargin.right;
    const drillInnerHeight = drillHeight - drillMargin.top - drillMargin.bottom;

    donorsSvg.attr("viewBox", `0 0 ${drillWidth} ${drillHeight}`);
    recipientsSvg.attr("viewBox", `0 0 ${drillWidth} ${drillHeight}`);

    const donorsG = donorsSvg.append("g")
      .attr("transform", `translate(${drillMargin.left},${drillMargin.top})`);
    const recipientsG = recipientsSvg.append("g")
      .attr("transform", `translate(${drillMargin.left},${drillMargin.top})`);

    const donorsXAxisG = donorsG.append("g")
      .attr("class", "axis")
      .attr("transform", `translate(0,${drillInnerHeight})`);
    const donorsYAxisG = donorsG.append("g").attr("class", "axis");

    const recipientsXAxisG = recipientsG.append("g")
      .attr("class", "axis")
      .attr("transform", `translate(0,${drillInnerHeight})`);
    const recipientsYAxisG = recipientsG.append("g").attr("class", "axis");

    const fmtShort = d => {
      const v = d3.format(".2s")(d);
      return v.replace("G", "B");
    };

    function normalizeName(name) {
      return String(name || "")
        .toLowerCase()
        .replace(/&/g, "and")
        .replace(/'/g, "")
        .replace(/\./g, "")
        .replace(/\s+/g, " ")
        .trim();
    }

    const nameAliases = {
      "united states of america": "united states",
      "democratic republic of the congo": "congo, dem. rep.",
      "republic of the congo": "congo, rep.",
      "cote divoire": "cote d'ivoire",
      "ivory coast": "cote d'ivoire",
      "myanmar": "myanmar (burma)"
    };

    Promise.all([
      d3.csv("/../data/aiddata-countries-only.csv", d3.autoType),
      d3.json("/../data/world-110m2.json")
    ]).then(([csv, worldTopo]) => {
      rawData = csv;

      const donatedRollup = d3.rollup(
        csv,
        v => d3.sum(v, d => d.commitment_amount_usd_constant || 0),
        d => d.donor
      );
      const receivedRollup = d3.rollup(
        csv,
        v => d3.sum(v, d => d.commitment_amount_usd_constant || 0),
        d => d.recipient
      );

      const allCountries = new Set([
        ...donatedRollup.keys(),
        ...receivedRollup.keys()
      ]);

      let maxAbsNet = 0;
      allCountries.forEach(c => {
        const donated = donatedRollup.get(c) || 0;
        const received = receivedRollup.get(c) || 0;
        const net = donated - received;
        const totalFlow = donated + received;
        const norm = normalizeName(c);
        countrySummary.set(norm, {
          country: c,
          total_donated: donated,
          total_received: received,
          net_aid: net,
          total_flow: totalFlow
        });
        maxAbsNet = Math.max(maxAbsNet, Math.abs(net));
      });

      const colorScale = d3.scaleDiverging()
        .domain([-maxAbsNet, 0, maxAbsNet])
        .interpolator(d3.interpolateRdBu); 

      const countries = topojson.feature(worldTopo, worldTopo.objects.countries);

      projection.fitSize([width, height], countries);

      mapG.selectAll("path.country")
        .data(countries.features)
        .join("path")
        .attr("class", "country")
        .attr("d", path)
        .each(function (d) {
          const props = d.properties || {};
          const rawName = props.name || props.ADMIN || props.admin || d.id;
          d._displayName = rawName || "Unknown";
          let normGeo = normalizeName(rawName);
          if (nameAliases[normGeo]) {
            normGeo = nameAliases[normGeo];
          }
          d._normName = normGeo;
        })
        .attr("fill", d => {
          const stats = countrySummary.get(d._normName);
          if (!stats) return "#e5e7eb";
          return colorScale(stats.net_aid);
        })
        .classed("no-data", d => !countrySummary.get(d._normName))
        .on("mouseenter", (event, d) => {
          const stats = countrySummary.get(d._normName);
          showMapTooltip(event, d._displayName, stats);
        })
        .on("mousemove", (event) => moveTooltip(event))
        .on("mouseleave", hideTooltip)
        .on("click", (event, d) => {
          const stats = countrySummary.get(d._normName);
          if (!stats) return;
          selectedCountry = stats.country;
          updateDrilldown(selectedCountry);
        });

      const zoom = d3.zoom()
        .scaleExtent([1, 8])
        .on("zoom", (event) => {
          mapG.attr("transform", event.transform);
        });

      svg.call(zoom);

      drawLegend(colorScale, maxAbsNet);
    }).catch(err => {
      console.error("Error loading data:", err);
    });

    function drawLegend(colorScale, maxAbsNet) {
      const legendWidth = 220;
      const legendHeight = 10;

      const gradientId = "net-aid-gradient";

      const defs = svg.append("defs");
      const gradient = defs.append("linearGradient")
        .attr("id", gradientId)
        .attr("x1", "0%")
        .attr("x2", "100%")
        .attr("y1", "0%")
        .attr("y2", "0%");

      const stops = [
        { offset: "0%", value: -maxAbsNet },
        { offset: "50%", value: 0 },
        { offset: "100%", value: maxAbsNet }
      ];

      stops.forEach(s => {
        gradient.append("stop")
          .attr("offset", s.offset)
          .attr("stop-color", colorScale(s.value));
      });

      legendG.append("text")
        .attr("class", "legend-title")
        .attr("x", 0)
        .attr("y", 0)
        .text("Net Aid (Donated − Received)");

      legendG.append("rect")
        .attr("x", 0)
        .attr("y", 8)
        .attr("width", legendWidth)
        .attr("height", legendHeight)
        .attr("fill", `url(#${gradientId})`);

      const scale = d3.scaleLinear()
        .domain([-maxAbsNet, maxAbsNet])
        .range([0, legendWidth]);

      const axis = d3.axisBottom(scale)
        .ticks(5)
        .tickFormat(d => {
          const v = d3.format(".2s")(d);
          return v.replace("G", "B");
        });

      const axisG = legendG.append("g")
        .attr("transform", `translate(0, ${8 + legendHeight})`)
        .call(axis);

      axisG.select("path").attr("stroke", "#d1d5db");
      axisG.selectAll("line").attr("stroke", "#d1d5db");
      axisG.selectAll("text").attr("fill", "#4b5563").attr("font-size", 10);
    }

    function showMapTooltip(event, countryName, stats) {
      const fmt = d3.format(",.2f");

      if (!stats) {
        tooltip
          .style("opacity", 1)
          .html(`<strong>${countryName}</strong><br/>No aid data in this dataset.`);
        moveTooltip(event);
        return;
      }

      const net = stats.net_aid;
      const netLabel = net >= 0 ? "Net Donor" : "Net Recipient";

      tooltip
        .style("opacity", 1)
        .html(`
          <strong>${stats.country}</strong><br/>
          Total Donated: ${fmt(stats.total_donated)}<br/>
          Total Received: ${fmt(stats.total_received)}<br/>
          Net Aid: ${fmt(net)} (${netLabel})<br/>
          Total Flow: ${fmt(stats.total_flow)}
        `);
      moveTooltip(event);
    }

    function moveTooltip(event) {
      const [x, y] = d3.pointer(event, document.body);
      tooltip
        .style("left", (x + 15) + "px")
        .style("top", (y + 15) + "px");
    }

    function hideTooltip() {
      tooltip.style("opacity", 0);
    }

    function updateDrilldown(country) {
      if (!country) return;

      const period = "All years";

      drilldownTitle.textContent =
        `Country relationships for ${country} (${period})`;
      topDonorsTitle.textContent = `Top donors to ${country} (${period})`;
      topRecipientsTitle.textContent = `Top recipients from ${country} (${period})`;

      const baseSubset = rawData;

      const donorsMap = d3.rollup(
        baseSubset.filter(d => d.recipient === country),
        v => d3.sum(v, d => d.commitment_amount_usd_constant || 0),
        d => d.donor
      );
      const donorsArr = Array.from(donorsMap, ([partner, value]) => ({ partner, value }))
        .sort((a, b) => d3.descending(a.value, b.value))
        .slice(0, 5);

      const recipientsMap = d3.rollup(
        baseSubset.filter(d => d.donor === country),
        v => d3.sum(v, d => d.commitment_amount_usd_constant || 0),
        d => d.recipient
      );
      const recipientsArr = Array.from(recipientsMap, ([partner, value]) => ({ partner, value }))
        .sort((a, b) => d3.descending(a.value, b.value))
        .slice(0, 5);

      drawPieChart(donorsG, donorsArr, { mode: "to", country, period });
      drawPieChart(recipientsG, recipientsArr, { mode: "from", country, period });
    }

    function showSliceTooltip(event, d, config) {
      const fmt = d3.format(",.2f");
      const title = config.mode === "to"
        ? `${d.data.partner} → ${config.country}`
        : `${config.country} → ${d.data.partner}`;
      tooltip
        .style("opacity", 1)
        .html(`
          <strong>${title}</strong><br/>
          Period: ${config.period}<br/>
          Total: ${fmt(d.data.value)} USD (constant)
        `);
      moveTooltip(event);
    }

function drawPieChart(group, data, config) {
  group.selectAll("*").remove();

  const filtered = data.filter(d => d.value > 0);

  if (!filtered.length) {
    group.append("text")
      .attr("class", "no-data-text")
      .attr("x", drillInnerWidth / 2)
      .attr("y", drillInnerHeight / 2)
      .attr("text-anchor", "middle")
      .text(`No data for ${config.country} (${config.period})`);
    return;
  }

  const radius = Math.min(drillInnerWidth, drillInnerHeight) / 2 - 5;

  const centerX = drillInnerWidth / 2;
  const centerY = drillInnerHeight / 2 - 60;

  const pie = d3.pie()
    .sort(null)
    .value(d => d.value);

  const arc = d3.arc()
    .innerRadius(radius * 0.4)  
    .outerRadius(radius);

  const color = d3.scaleOrdinal()
    .domain(filtered.map(d => d.partner))
    .range(d3.schemeTableau10);

  const pieG = group.append("g")
    .attr("transform", `translate(${centerX},${centerY})`);

  pieG.selectAll("path")
    .data(pie(filtered), d => d.data.partner)
    .join("path")
    .attr("d", arc)
    .attr("fill", d => color(d.data.partner))
    .attr("stroke", "#ffffff")
    .attr("stroke-width", 1)
    .on("mouseenter", (event, d) => showSliceTooltip(event, d, config))
    .on("mousemove", (event) => moveTooltip(event))
    .on("mouseleave", hideTooltip);

  const legend = group.append("g")
    .attr("transform", `translate(0, ${drillInnerHeight - 30})`);

  const legendItems = legend.selectAll("g")
    .data(filtered)
    .join("g")
    .attr("transform", (d, i) =>
      `translate(${(i % 2) * (drillInnerWidth / 2)}, ${Math.floor(i / 2) * 16})`
    );

  legendItems.append("rect")
    .attr("x", 0)
    .attr("y", -10)
    .attr("width", 10)
    .attr("height", 10)
    .attr("fill", d => color(d.partner));

  legendItems.append("text")
    .attr("x", 14)
    .attr("y", -2)
    .attr("font-size", 10)
    .attr("fill", "#4b5563")
    .text(d => d.partner);
}
  </script>
</body>
</html>
