<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Global Aid Distribution (JSON Source)</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #f4f7f6;
        }

        #controls {
            margin: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        select {
            padding: 8px;
            font-size: 16px;
        }

        #vis-container {
            position: relative;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 10px;
            border-radius: 4px;
            pointer-events: none;
            font-size: 13px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .legend text {
            font-size: 12px;
        }

        .legend-title {
            font-weight: bold;
            font-size: 14px;
        }

        .vis-card {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            background: #ffffff;
            border-radius: 12px;
            padding: 1rem 1.1rem;
            text-decoration: none;
            color: inherit;
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.06);
            border: 1px solid #e5e7eb;
            transition:
                transform 0.15s ease,
                box-shadow 0.15s ease,
                border-color 0.15s ease,
                background 0.15s ease;
        }

        .vis-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
            border-color: #3b82f6;
            background: #f9fafb;
        }

        .vis-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.4rem;
        }

        .vis-tag {
            display: inline-flex;
            align-items: center;
            font-size: 0.7rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: #2563eb;
            background: #eff6ff;
            border-radius: 999px;
            padding: 0.2rem 0.55rem;
            margin-bottom: 0.5rem;
        }

        .vis-desc {
            font-size: 0.85rem;
            color: #4b5563;
            margin-bottom: 0.9rem;
            line-height: 1.4;
        }


        /* nav button styling */
        /* Container to help position the button (optional) */
        .nav-container {
            display: inline-block;
            position: relative;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* The Button Styling */
        .nav-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background-color: #f0f4f8;
            /* Light background */
            color: #2d3748;
            /* Dark text */
            padding: 10px 20px;
            border-radius: 50px;
            /* Pill shape */
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            border: 1px solid #cbd5e0;
            transition: all 0.2s ease;
            position: relative;
            /* Needed for tooltip positioning */
        }

        /* Hover Effect for Button */
        .nav-btn:hover {
            background-color: #2b6cb0;
            /* Blue on hover */
            color: white;
            border-color: #2b6cb0;
            transform: translateY(-2px);
            /* Slight lift */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Arrow Animation on Hover */
        .nav-btn:hover .btn-icon {
            transform: translateX(4px);
        }

        .btn-icon {
            transition: transform 0.2s ease;
        }

        /* --- Tooltip Styling --- */

        /* Container and Button Styling (Same as before) */
        .nav-container {
            display: inline-block;
            position: relative;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .nav-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background-color: #f0f4f8;
            color: #2d3748;
            padding: 10px 20px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            border: 1px solid #cbd5e0;
            transition: all 0.2s ease;
            position: relative;
        }

        .nav-btn:hover {
            background-color: #2b6cb0;
            color: white;
            border-color: #2b6cb0;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .nav-btn:hover .btn-icon {
            transform: translateX(4px);
        }

        .btn-icon {
            transition: transform 0.2s ease;
        }

        /* --- UPDATED Tooltip Styling (Below) --- */

        .tooltip-content {
            visibility: hidden;
            opacity: 0;
            width: 250px;
            background-color: #2d3748;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 12px;
            position: absolute;
            z-index: 100;

            /* Changed: Position below the button */
            top: 135%;
            /* Pushes it down below the element */
            left: 50%;

            /* Animation start state: slightly higher */
            transform: translateX(-50%) translateY(-10px);

            transition: opacity 0.3s, transform 0.3s;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            font-size: 12px;
            line-height: 1.4;
            font-weight: 400;
        }

        /* The Triangle Arrow (Flipped to point up) */
        .tooltip-content::after {
            content: "";
            position: absolute;

            /* Position at the TOP of the tooltip */
            bottom: 100%;
            left: 50%;
            margin-left: -5px;

            border-width: 5px;
            border-style: solid;

            /* Color order: Top, Right, Bottom, Left */
            /* Bottom has color to point UP */
            border-color: transparent transparent #2d3748 transparent;
        }

        /* Show Tooltip on Hover */
        .tooltip-trigger:hover .tooltip-content {
            visibility: visible;
            opacity: 1;
            /* Slide down into final position */
            transform: translateX(-50%) translateY(0);
        }
    </style>
</head>

<body>

    <h2>Geographical Distribution of Aid Sorted by Top 5 Purposes</h2>

    <div class="nav-container">
        <a href="vis3bc.html" class="nav-btn tooltip-trigger">
            <span class="btn-text">Go to Visualization 3C: Local Top 5 Purposes</span>
            <span class="btn-icon">â†’</span>

            <div class="tooltip-content">
                <p>Represents top 5 funding sources for each country using a Glyph Map and pie charts. Each pie chart is
                    located at the center of a country.</p>
            </div>
        </a>
    </div>

    </a>

    <div id="controls">
        <label for="purposeSelect"><strong>Select Aid Purpose:</strong> </label>
        <select id="purposeSelect"></select>
    </div>



    <div id="vis-container">
        <div id="tooltip" class="tooltip"></div>
    </div>
    <script>
        const width = 1000;
        const height = 600;

        // --- 1. NAME MAPPING ---
        // Even with JSON, you still need this if your JSON says "United States" 
        // but the map says "USA".
        const nameMapping = {
            "United States": "USA",
            "United Kingdom": "England",
            "Korea": "South Korea",
            "Slovak Republic": "Slovakia",
            "Czech Republic": "Czech Republic",
            "Russian Federation": "Russia",
            "Congo, Dem. Rep.": "Democratic Republic of the Congo",
            "Tanzania": "United Republic of Tanzania"
        };

        const svg = d3.select("#vis-container")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

        const projection = d3.geoMercator()
            .scale(130)
            .translate([width / 2, height / 1.5]);

        const path = d3.geoPath().projection(projection);

        Promise.all([
            d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson"),
            // --- CHANGE HERE: Load JSON instead of CSV ---
            d3.json("../data/processed_aid_data_updated.json")
        ]).then(([topo, jsonData]) => {

            // const topPurposes = [
            //     'Sectors not specified', 
            //     'Social/ welfare services', 
            //     'Strengthening civil society', 
            //     'Higher education', 
            //     'Multisector aid'
            // ];
            let topPurposes = [];
            if (jsonData.length > 0 && jsonData[0].global_breakdown) {
                // Object.keys returns ["Higher education", "Multisector aid", ...]
                topPurposes = Object.keys(jsonData[0].global_breakdown);
            }

            // --- SIMPLIFIED DATA MAPPING ---
            // We no longer need to calculate sums here. The JSON has them.
            // Structure expected: { "country": "India", "global_breakdown": { "Purpose A": 100 } }

            const dataMap = new Map();

            jsonData.forEach(d => {
                let country = d.country;
                // Apply name mapping
                if (nameMapping[country]) {
                    country = nameMapping[country];
                }

                // Store the pre-calculated 'global_breakdown' object directly
                if (d.global_breakdown) {
                    dataMap.set(country, d.global_breakdown);
                }
            });

            console.log("JSON Data Loaded. Map keys:", Array.from(dataMap.keys()));

            // --- POPULATE DROPDOWN ---
            const select = d3.select("#purposeSelect");
            select.selectAll("option")
                .data(topPurposes)
                .enter().append("option")
                .text(d => d)
                .attr("value", d => d);

            // --- DRAW MAP ---
            const mapPaths = svg.selectAll("path")
                .data(topo.features)
                .enter().append("path")
                .attr("d", path)
                .attr("stroke", "#999")
                .attr("stroke-width", 0.5)
                .attr("fill", "#eee")
                .on("mouseover", function (event, d) {
                    d3.select(this).attr("stroke", "black").attr("stroke-width", 1.5);
                    tooltip.style("opacity", 1);
                })
                .on("mousemove", function (event, d) {
                    const purpose = select.property("value");
                    const countryName = d.properties.name;

                    const record = dataMap.get(countryName);
                    // Direct access: record is now { "Purpose A": 100, ... }
                    const value = (record && record[purpose]) ? record[purpose] : 0;

                    const formattedValue = value > 0
                        ? "$" + (value / 1000000).toFixed(1) + " M"
                        : "No Data";

                    tooltip.html(`<strong>${countryName}</strong><br/>${formattedValue}`)
                        .style("left", (event.pageX + 15) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function () {
                    d3.select(this).attr("stroke", "#999").attr("stroke-width", 0.5);
                    tooltip.style("opacity", 0);
                });

            const tooltip = d3.select("#tooltip");

            // --- UPDATE FUNCTION ---
            function updateMap(selectedPurpose) {
                // Find max value for this purpose
                let maxVal = 0;
                for (let [country, breakdown] of dataMap) {
                    if (breakdown[selectedPurpose] > maxVal) {
                        maxVal = breakdown[selectedPurpose];
                    }
                }

                const dynamicColorScale = d3.scaleSequential(d3.interpolateBlues)
                    .domain([0, maxVal]);

                mapPaths.transition().duration(750)
                    .attr("fill", function (d) {
                        const countryName = d.properties.name;
                        const record = dataMap.get(countryName);

                        if (record && record[selectedPurpose] > 0) {
                            return dynamicColorScale(record[selectedPurpose]);
                        } else {
                            return "#eee";
                        }
                    });

                updateLegend(dynamicColorScale, maxVal);
            }

            function updateLegend(colorScale, maxVal) {
                svg.select(".legend-group").remove();

                const legendWidth = 300;
                const legendHeight = 10;
                const legendX = 20;
                const legendY = height - 50;

                const legendGroup = svg.append("g").attr("class", "legend-group")
                    .attr("transform", `translate(${legendX}, ${legendY})`);

                const defs = svg.append("defs");
                const linearGradient = defs.append("linearGradient")
                    .attr("id", "linear-gradient");

                linearGradient.selectAll("*").remove();

                linearGradient.selectAll("stop")
                    .data(d3.range(0, 1.1, 0.1))
                    .enter().append("stop")
                    .attr("offset", d => d * 100 + "%")
                    .attr("stop-color", d => colorScale(d * maxVal));

                legendGroup.append("rect")
                    .attr("width", legendWidth)
                    .attr("height", legendHeight)
                    .style("fill", "url(#linear-gradient)");

                legendGroup.append("text").attr("x", 0).attr("y", -5).text("0");
                legendGroup.append("text").attr("x", legendWidth).attr("y", -5).attr("text-anchor", "end")
                    .text("$" + (maxVal / 1000000).toFixed(0) + "M");
                legendGroup.append("text").attr("x", 0).attr("y", 25).attr("class", "legend-title")
                    .text("Commitment Amount (USD Constant)");
            }

            updateMap(topPurposes[0]);

            select.on("change", function () {
                updateMap(this.value);
            });

        }).catch(err => {
            console.error("Error loading data:", err);
            d3.select("#vis-container").append("p").text("Error loading JSON. Check console (F12).");
        });
    </script>


</body>

</html>